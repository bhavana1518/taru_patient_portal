<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AI Lab Result Summarizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body
    class="bg-gray-50 text-gray-800 min-h-screen flex flex-col items-center p-6"
  >
    <h1 class="text-3xl font-bold text-blue-700 mb-6 text-center">
      üß† AI-Powered Lab Result Summaries
    </h1>

    <!-- Input for Patient ID -->
    <div class="flex flex-col md:flex-row items-center gap-3 mb-6">
      <input
        id="patientIdInput"
        type="text"
        placeholder="Enter Patient ID (e.g. example)"
        class="border border-gray-300 rounded-lg px-4 py-2 w-64 focus:ring-2 focus:ring-blue-500 outline-none"
      />
      <button
        id="fetchLabsBtn"
        class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition"
      >
        Fetch Lab Results
      </button>
    </div>

    <!-- Loading Indicator -->
    <div
      id="loading"
      class="hidden text-blue-600 font-semibold flex items-center gap-2"
    >
      <svg
        class="animate-spin h-5 w-5 text-blue-600"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8v8H4z"
        ></path>
      </svg>
      Fetching lab results...
    </div>

    <!-- Error Message -->
    <div id="error" class="text-red-600 mt-4 font-semibold"></div>

    <!-- Table -->
    <div class="w-full max-w-6xl mt-6">
      <table
        id="labsTable"
        class="hidden w-full text-left border border-gray-300 rounded-lg overflow-hidden"
      >
        <thead class="bg-gray-200">
          <tr>
            <th class="p-3">Test Name</th>
            <th class="p-3">Value</th>
            <th class="p-3">Status</th>
            <th class="p-3">Date</th>
            <th class="p-3 w-1/2">AI Summary</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200"></tbody>
      </table>
    </div>

    <script>
      const fetchBtn = document.getElementById("fetchLabsBtn");
      const patientInput = document.getElementById("patientIdInput");
      const loadingDiv = document.getElementById("loading");
      const errorDiv = document.getElementById("error");
      const labsTable = document
        .getElementById("labsTable")
        .getElementsByTagName("tbody")[0];

      fetchBtn.addEventListener("click", async () => {
        const patientId = patientInput.value.trim();
        if (!patientId) {
          errorDiv.textContent = "‚ö†Ô∏è Please enter a patient ID first.";
          return;
        }

        loadingDiv.classList.remove("hidden");
        errorDiv.textContent = "";
        labsTable.parentElement.classList.add("hidden");
        labsTable.innerHTML = "";

        try {
          const response = await fetch(`/labs?patient_id=${patientId}`);
          const data = await response.json();

          if (response.status !== 200) {
            throw new Error(data.error || "Unknown error");
          }

          data.forEach((lab) => {
            const row = labsTable.insertRow();
            row.insertCell(0).textContent = lab.test_name;
            row.insertCell(1).textContent = `${lab.value} ${lab.unit}`;
            row.insertCell(2).textContent = lab.status;
            row.insertCell(3).textContent = lab.effectiveDateTime;

            const summaryCell = row.insertCell(4);
            const summaryBox = document.createElement("div");
            summaryBox.className =
              "bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-gray-700";
            summaryBox.textContent = lab.summary;
            summaryCell.appendChild(summaryBox);
          });

          labsTable.parentElement.classList.remove("hidden");
        } catch (err) {
          errorDiv.textContent = `‚ö†Ô∏è Error fetching labs: ${err.message}`;
        } finally {
          loadingDiv.classList.add("hidden");
        }
      });
    </script>
  </body>
</html>
